# Chapter 5. 网络层：控制面

## 5.1 概述

路由算法分为**每路由器控制**和**逻辑集中式路由器控制**。前者是由每一个路由器自己运行路由选择算法生成转发表，后者是由统一的控制器运行路由选择算法生成转发表。

## 5.2 路由选择算法

路由选择算法的目的是，确定一条从发送方到接收方的过程中通过路由器的好的路径，一般是最低开销的路径。

为了描述好路由选择算法，我们使用图来形式化描述网络：`G=(N,E)`，其中图`G`是一个包含`N`个节点`E`条边的集合。同时，每一条边上还由一个权重标识开销。我们要做的就是从一个节点`u`找到到所有其他节点的最低开销路径集合。也成为**最短路径**。

![](image/chapter4/5.2.1.png)

### 5.2.1 链路状态路由选择算法（LS算法）

具有全局状态的算法称为链路状态算法。在实践中是让每一个节点向网络中的所有节点广播链路状态分组。LS算法内部实现是Dijkstra算法，具体实现步骤如下。

#### 5.2.1.1 Dijkstra算法思想

Dijkstra算法解决的是单源点最短路径问题：给定带权有向图G和源点v0，求从v0到G中其余个顶点的最短路径，即一个出发点到达其他顶点的最短路径。Dijkstra算法的思想是按照路径长度递增的次序产生最短路径的算法。

#### 5.2.1.2 算法流程
首先定义下列记号
- `D(v)`: 到算法的本次迭代，从源节点到目的节点v的最低开销路径的开销。
- `p(v)`: 从源到v沿着当前最低开销路径的前一个节点（也就是v的邻居）。
- `N'`:   节点子集，如果从源到v的最低开销路径已知，则在集合中

初始化过程如下，最开始已知的最短路径集合中只有节点`u`，之后在其他所有的节点中，如果`v`是`u`的邻居，那么其开销设置为邻边的权重，否则开销则为无穷大。
```
# Initialization
-----------------------------
N' = {u}
for all nodes v:
    if v is a neighbor of u:
        then D(v) = c(u,v)
    else:
        D(v) = _MAX_
```

之后就进入循环，循环的次数为节点数量。

```
Loop：
    find w not in N' such that D(w) is a minimum
    add w to N'
    update D(v) for each neighbor v of w ans not in N':
        D(v) = min(D(v), D(w)+c(w,v))
until N'=N
```
上面的伪代码流程表示，一轮只加入一个节点，并且没加入一个节点，邻居节点的值就会有可能更新。

#### 5.2.1.3 代码实现

略，[代码详情见博客](https://www.cnblogs.com/linfangnan/p/12803201.html)

#### 5.2.1.4 振荡问题

LS算法产生的振荡问题简单来说就是，当网络中的节点检测到一条好的链路时，大家第一跳发送就会都走那条链路；结果链路情况变差，原来不好的链路又变成和好的，因此数据报又回来，来来回回，数据报会在网络中乱窜。

形象的比喻就是一堆人走平衡木，觉得另一边人少结果所有人都去另一边，导致原先的一边又空了。

解决的方法就是，确保并非所有的路由器都同时运行LS算法，避免自同步。

### 5.2.2 距离向量路由选择算法

距离向量算法是一种迭代的、异步的和分布式的算法，其被称为分布式是因为每一个节点都要从一个或者多个直接相连的邻居节点接收信息，执行计算，然后将计算结果分发给邻居。迭代是因为这个过程会一直持续到邻居之间没有更多的信息需要交换。

DV算法的原理如下：
```
d_x(y) = min_v{c(x,y),d_v(y)}
```

该算法的步骤类似于，当前节点到别的节点的距离，是邻居到别的节点的距离+当前节点-邻居，然后取最小值。

## 5.3 OSPF自治系统内部的路由选择

OSPF开放最短路优先，是一种广泛用于AS内部的路由选择协议。首先OSPF是一种链路状态协议，使用洪范链路状态信息和Dijkstra算法，使用了OSPF以后，一台路由器就构建了一幅关于整个AS的完整拓扑图，每一台路由器就确定了一个以自身为根节点到所有子网的最短路径树。


## 5.4 BGP(ISP之间的路由选择)

BGP协议可以被称为因特网的粘合剂，用于确定AS之间的路由选择。

### 5.4.1 BGP的作用
对于一个AS和AS内的某一个路由器，在路由器中有一个转发表，用于选择和确定分组在路由器的输出链路。对于分组需要发送到AS之外时，BGP提供的并不是特定的目的地址，而是提供了一个通过CIDR得到的网络前缀，这个网络前缀能够标志一个子网或一个子网的集合。概括起来，BGP的作用是：容许子网向路由器其余部分通告它的存在。

![](image/chapter4/5.4.1.png)

### 5.4.2 BGP的任务

BGP 对于每一台路由器来说，需要完成 2 个任务：

1. 从临近的AS获得前缀可达性信息：BGP允许每个子网向因特网的其他部分告知自己的存在，同时BGP确保在因特网中所有的AS都知道该子网；
2. 确定到达子网的最佳路由：路由器将在本地允许BGP路由选择过程，此时BGP协议需要基于网络前缀的可达性信息，向路由器提供最佳路由。

...略


## 5.5 SDN控制平面

### 5.5.1 SDN体系结构的4个特征

1. 基于流的转发
   
   SDN控制的交换机的转发分组，能够基于传输层、网络层或链路层的任意字段进行。

2. 数据面控制面分离
   
   交换机只负责“匹配+动作”。

3. 网络控制功能
   
   控制平面一般由SDN控制器和若干网络控制功能组成，网络控制功能可以在服务器上远程运行。

4. 可编程网络
   
   如P4.

## 5.6 ICMP因特网控制报文协议

ICMP用于主机和路由器沟通网络层信息。最典型的用途是差错报告，例如运行一个HTTP会话，如果IP路由器无法找到通往HTTP请求的主机的路径，就会返回“目的网络不可达”这样的错误信息。

ICMP通常被认为是IP的一部分，但是从体系结构讲它是位于IP之上的。因此ICMP的报文和TCP/UDP一样是作为有效载荷放在IP分组中的。ICMP报文由一个**类型字段**和**编码字段**，并且包含了首次引起该ICMP报文的IP数据报的首部和前8个字节。

![](image/chapter4/5.6.1.png)

## 5.6.2 Traceroute

Traceroute允许跟踪从一台主机到世界上任何一台主机之间的路由。Traceroute就是ICMP报文实现的。为了判断所有从源到目的之间的路由器名字和地址，源主机中的Traceroute向目的主机发送了一系列普通的IP数据报，每个数据报携带了一个具有不可达UDP端口和UDP报文段。

第一个数据报TTL设为1，第二个设为2，以此类推。因为根据IP协议规则，路由器丢弃该数据报需要发送一个ICMP告警报文给源主机，该告警报文包含了路由器的名字和IP地址。

而源主机可以通过ICMP报文的类型分辨是否到达了目标主机，因此目的主机会返回一个“端口不可达”的ICMP控制报文。

## 5.7 网络管理和SNMP

略。